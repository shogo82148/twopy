#!/usr/bin/env python
#-*- coding:utf-8 -*-

import urllib.request, urllib.parse, urllib.error
import time
import re
import twopy
from . import utility


class Board:
    """
    2chの板全般を管理するクラスです。
    """

    __tr_re = re.compile(r"(?P<title>.*) \((?P<res>\d*)\)")
    __server_re = re.compile(r"http://.+?/")
    __name_re = re.compile(r"http://.+?/(.+?)/")

    def __init__(self, url, user=None):
        """
        オブジェクトのコンストラクタです。

        url: 対象の2ch板のURL
        user: 通信に用いるtwopy.Userクラスのインスタンス
        """
        u = url.endswith("/") and url or url + "/"
        self.__url = u
        self.__user = user if user else twopy.User.anonymouse()
        self.__isRetrieved = False

        self.__index = 0
        self.__threads = []

    def getUrl(self):
        return self.__url

    def setUrl(self, url):
        if type(url) == str:
            self.__url = url
        else:
            raise AttributeError
    url = property(getUrl, setUrl)

    def getConfig(self):
        return self.__conf

    def setConfig(self, conf):
        self.__conf = conf
    config = property(getConfig, setConfig)

    def getSubject(self):
        su = self.url + "subject.txt" if self.url.endswith("/") \
             else self.url + "/subject.txt"
        return su
    subject_url = property(getSubject)

    def getBBS(self):
        b = self.url.endswith("/") and \
                self.url + "test/bbs.cgi" or self.url + "/test/bbs.cgi"
        return b

    def get_isRetrieved(self):
        return self.__isRetrieved
    isRetrieved = property(get_isRetrieved)

    def getUser(self):
        return self.__user
    user = property(getUser)

    def getServer(self):
        return Board.__server_re.search(self.url).group(0)
    server = property(getServer)

    def getName(self):
        return Board.__name_re.search(self.url).group(1)
    name = property(getName)

    def __init_threads(self):
        self.__threads = []
        self.__isRetrieved = False

    def retrieve(self):
        """
        対象の板からスレッド一覧を取得します。
        """
        self.__init_threads()

        try:
            response = self.user.urlopen(self.subject_url, gzip=False)
        except urllib.error.HTTPError as e:
            return e.code
        if response.code == 200:
            rawdata = str(response.read(), 'MS932', 'ignore')
            dat = rawdata.split("\n")
            for thread_str in dat:
                columns = thread_str.split("<>")
                if len(columns) < 2:
                    continue
                r = Board.__tr_re.search(columns[1])
                title = r.group("title")
                res = int(r.group("res"))
                th = twopy.Thread(self, columns[0], self.user, title, res)
                self.__threads.append(th)
            self.__isRetrieved = True
        return response.code

    def createNewThread(self, subject="", name="", mailaddr="", message="",
                        submit="新規スレッド作成", hidden={}, delay=5):
        """
        新しくスレッドを生成します.

        引数:
        subject: スレッドのタイトル
        name: 名前
        mailaddr: メールアドレス
        message: 本文の文章
        submit: 書き込みボタンのキャプション
        hidden: hidden属性の値
        delay: 本来の時間から何秒だけ後戻りさせるか(未来の時間に書き込むのを防ぐ)

        返り値:
        レスポンスコードと受信した文章の本文のタプル.
        レスポンスコード:
        twopy.STATUS_TRUE: 書き込み成功
        twopy.STATUS_FALSE: 書き込み成功&警告
        twopy.STATUS_ERROR: 書き込み失敗
        twopy.STATUS_CHECK: 書き込み警告
        twopy.STATUS_COOKIE: 書き込み確認

        ただし、レスポンスコードがtwopy.STATUS_COOKIEの場合、
        返り値はレスポンスコード、受信した文章の本文、
        input->hidden属性の辞書が返されます.
        """
        referer = self.url
        send_dict = {"bbs": self.name,
                     "subject": subject.encode("MS932"),
                     "time": int(time.time()) - delay,
                     "FROM": name.encode("MS932"),
                     "mail": mailaddr.encode("MS932"),
                     "MESSAGE": message.encode("MS932"),
                     "submit": submit.encode("MS932")}
        send_dict.update(hidden)
        params = urllib.parse.urlencode(send_dict)

        return utility.bbsPost(self.user, self, params, referer)

    def __len__(self):
        if not self.isRetrieved:
            raise twopy.NotRetrievedError
        return len(self.__threads)

    def __iter__(self):
        if not self.isRetrieved:
            raise twopy.NotRetrievedError
        for thread in self.__threads:
            yield thread

    def __getitem__(self, i):
        if not self.isRetrieved:
            raise twopy.NotRetrievedError
        return self.__threads[i]
